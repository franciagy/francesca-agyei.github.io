<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Preventivo Pro – Supabase</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
  <style>
    /* include your existing CSS rules here */
  </style>
</head>
<body class="text-slate-800">
  <!-- Loader, Auth view, App view... same as your previous layout -->
  <div id="loader-overlay" class="loader-overlay active fixed inset-0 bg-white items-center justify-center z-[100]">…</div>
  <div id="auth-view" class="hidden min-h-screen flex items-center justify-center bg-slate-100 p-4">…</div>
  <div id="app" class="flex h-screen bg-slate-100 hidden">… your full app layout …</div>

  <script type="module">
    import { createClient } from '@supabase/supabase-js';
    const supabase = createClient('https://jneqdbzwfbcdjzctbkyr.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpuZXFkYnp3ZmJjZGp6Y3lyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ1MDAzNjgsImV4cCI6MjA3MDA3NjM2OH0.iL2RERw9JJyu_vVGbwP3QWGOHXmfC7f8qmGsyMRtUko');

    const authError = document.getElementById('auth-error');
    const loginForm = document.getElementById('login-form');
    const registerForm = document.getElementById('register-form');
    const loginBtn = document.getElementById('login-btn');
    const registerBtn = document.getElementById('register-btn');
    const showRegister = document.getElementById('show-register');
    const showLogin = document.getElementById('show-login');
    const authView = document.getElementById('auth-view');
    const appEl = document.getElementById('app');
    const logoutBtn = document.getElementById('logout-btn');
    const userEmailDisplay = document.getElementById('user-email');

    showRegister.addEventListener('click', e => { e.preventDefault(); loginForm.classList.add('hidden'); registerForm.classList.remove('hidden'); authError.textContent = ''; });
    showLogin.addEventListener('click', e => { e.preventDefault(); registerForm.classList.add('hidden'); loginForm.classList.remove('hidden'); authError.textContent = ''; });

    loginBtn.addEventListener('click', async () => {
      authError.textContent = '';
      const { error } = await supabase.auth.signInWithPassword({ email: document.getElementById('login-email').value, password: document.getElementById('login-password').value });
      if (error) authError.textContent = `Login error: ${error.message}`;
    });

    registerBtn.addEventListener('click', async () => {
      authError.textContent = '';
      const { error } = await supabase.auth.signUp({ email: document.getElementById('register-email').value, password: document.getElementById('register-password').value });
      if (error) authError.textContent = `Registration error: ${error.message}`;
      else authError.textContent = 'Check your email to confirm registration.';
    });

    supabase.auth.onAuthStateChange((event, session) => {
      if (session?.user) {
        userEmailDisplay.textContent = session.user.email;
        authView.classList.add('hidden');
        appEl.classList.remove('hidden');
        initAppForUser(session.user.id);
      } else {
        appEl.classList.add('hidden');
        authView.classList.remove('hidden');
        userEmailDisplay.textContent = '';
      }
    });

    logoutBtn.addEventListener('click', async () => await supabase.auth.signOut());

    async function initAppForUser(uid) {
      // Load or create user settings
      let { data: userRow } = await supabase.from('users').select().eq('id', uid).single();
      if (!userRow) {
        await supabase.from('users').insert({ id: uid, clients: [], products: [], company: {}, pdf_color: '#4f46e5', next_quote_number: 1 });
        userRow = (await supabase.from('users').select().eq('id', uid).single()).data;
      }
      applySettings(userRow);

      const { data: quotes } = await supabase.from('quotes').select().eq('user_id', uid);
      renderArchive(quotes);
      updateDashboard(quotes);

      // Setup listener via realtime (optional)
      supabase.from(`quotes:user_id=eq.${uid}`).on('INSERT', payload => {
        loadAllQuotes(uid);
      }).subscribe();
    }

    async function loadAllQuotes(uid) {
      const { data: quotes } = await supabase.from('quotes').select().eq('user_id', uid);
      renderArchive(quotes);
      updateDashboard(quotes);
    }

    async function updateUserData(changes) {
      const user = supabase.auth.user();
      await supabase.from('users').update(changes).eq('id', user.id);
    }

    // Insert your applySettings(), renderClients(), renderProducts(),
    // renderArchive(), updateDashboard(), gatherQuoteDataFromForm(),
    // saveQuote(), generatePDF(), switchView(), etc. functions from your original code,
    // adjusting Firestore calls to use updateUserData(), supabase.from('quotes').insert(), loadAllQuotes() and so on.

    // On page load check session immediately
    (async () => {
      const { data: { session } } = await supabase.auth.getSession();
      if (session?.user) {
        userEmailDisplay.textContent = session.user.email;
        authView.classList.add('hidden');
        appEl.classList.remove('hidden');
        await initAppForUser(session.user.id);
      }
    })();
  </script>
</body>
</html>
