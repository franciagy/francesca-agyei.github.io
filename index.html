<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Preventivo Pro - Dashboard Premium</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, addDoc, query, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        const firebaseConfig = typeof __firebase_config !== 'undefined'
            ? JSON.parse(__firebase_config)
            : {
                apiKey: "API_KEY_PLACEHOLDER", authDomain: "PROJECT_ID.firebaseapp.com", projectId: "PROJECT_ID",
                storageBucket: "PROJECT_ID.appspot.com", messagingSenderId: "SENDER_ID", appId: "APP_ID"
            };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        window.fb = { auth, db, onAuthStateChanged, doc, getDoc, setDoc, collection, addDoc, onSnapshot, query, updateDoc, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut };
    </script>
    
    <!-- Chart.js for Analytics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        .sidebar { transition: transform 0.3s ease-in-out; }
        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); position: fixed; z-index: 40; height: 100%; }
            .sidebar.open { transform: translateX(0); }
            .overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0,0,0,0.5); z-index: 30; }
        }
        .gradient-button { background-image: linear-gradient(to right, #4f46e5, #7c3aed); transition: all 0.3s ease; }
        .gradient-button:hover { box-shadow: 0 10px 15px -3px rgba(79, 70, 229, 0.4), 0 4px 6px -2px rgba(79, 70, 229, 0.2); transform: translateY(-2px); }
        .gradient-button:disabled { opacity: 0.6; transform: none; cursor: not-allowed; }
        .modal, .loader-overlay { display: none; }
        .modal.active, .loader-overlay.active { display: flex; }
        .nav-link.active { background-color: #eef2ff; color: #4f46e5; font-weight: 600; }
        .shake { animation: shake 0.5s; }
        @keyframes shake {
            0%, 20%, 40%, 60%, 80% { transform: translateX(-5px); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(5px); }
        }
        .success-message {
            background: linear-gradient(90deg, #10b981, #059669);
            color: white;
            padding: 0.75rem;
            border-radius: 0.5rem;
            margin-top: 1rem;
            font-size: 0.875rem;
            text-align: center;
        }
    </style>
</head>
<body class="text-slate-800">

    <div id="loader-overlay" class="loader-overlay active fixed inset-0 bg-white items-center justify-center z-[100]">
        <div class="text-center">
            <svg class="animate-spin h-10 w-10 text-indigo-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p id="loader-text" class="mt-4 font-semibold text-slate-600">Caricamento...</p>
        </div>
    </div>

    <!-- VISTA AUTENTICAZIONE -->
    <div id="auth-view" class="hidden min-h-screen flex items-center justify-center bg-slate-100 p-4">
        <div class="w-full max-w-md">
            <h1 class="text-3xl font-bold text-center text-transparent bg-clip-text bg-gradient-to-r from-indigo-500 to-purple-600 mb-8">Preventivo Pro</h1>
            <div class="bg-white p-8 rounded-2xl shadow-lg">
                <!-- Form di Login -->
                <div id="login-form">
                    <h2 class="text-2xl font-bold text-slate-800 mb-6">Accedi al tuo account</h2>
                    <div class="space-y-4">
                        <div>
                            <label for="login-email" class="block text-sm font-medium text-slate-700 mb-2">Email</label>
                            <input type="email" id="login-email" placeholder="la-tua-email@esempio.com" 
                                   class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-colors">
                        </div>
                        <div>
                            <label for="login-password" class="block text-sm font-medium text-slate-700 mb-2">Password</label>
                            <input type="password" id="login-password" placeholder="••••••••" 
                                   class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-colors">
                        </div>
                        <button id="login-btn" class="w-full gradient-button text-white font-bold py-3 px-4 rounded-lg transition-all flex items-center justify-center gap-2">
                            <span id="login-btn-text">Accedi</span>
                            <svg id="login-spinner" class="hidden animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                        </button>
                    </div>
                    <p class="text-center text-sm text-slate-500 mt-6">
                        Non hai ancora un account? 
                        <a href="#" id="show-register" class="font-semibold text-indigo-600 hover:underline transition-colors">Registrati gratuitamente</a>
                    </p>
                </div>
                
                <!-- Form di Registrazione -->
                <div id="register-form" class="hidden">
                    <h2 class="text-2xl font-bold text-slate-800 mb-6">Crea il tuo account</h2>
                    <div class="space-y-4">
                        <div>
                            <label for="register-email" class="block text-sm font-medium text-slate-700 mb-2">Email</label>
                            <input type="email" id="register-email" placeholder="la-tua-email@esempio.com" 
                                   class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-colors">
                        </div>
                        <div>
                            <label for="register-password" class="block text-sm font-medium text-slate-700 mb-2">Password</label>
                            <input type="password" id="register-password" placeholder="••••••••" 
                                   class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-colors">
                            <p class="text-xs text-slate-500 mt-1">Minimo 6 caratteri</p>
                        </div>
                        <div>
                            <label for="register-password-confirm" class="block text-sm font-medium text-slate-700 mb-2">Conferma Password</label>
                            <input type="password" id="register-password-confirm" placeholder="••••••••" 
                                   class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-colors">
                        </div>
                        <button id="register-btn" class="w-full gradient-button text-white font-bold py-3 px-4 rounded-lg transition-all flex items-center justify-center gap-2">
                            <span id="register-btn-text">Crea Account</span>
                            <svg id="register-spinner" class="hidden animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                        </button>
                    </div>
                    <p class="text-center text-sm text-slate-500 mt-6">
                        Hai già un account? 
                        <a href="#" id="show-login" class="font-semibold text-indigo-600 hover:underline transition-colors">Accedi qui</a>
                    </p>
                </div>
                
                <!-- Messaggi di errore e successo -->
                <div id="auth-error" class="hidden text-red-600 bg-red-50 border border-red-200 rounded-lg p-3 text-sm text-center mt-4"></div>
                <div id="auth-success" class="hidden success-message"></div>
            </div>
        </div>
    </div>

    <div id="app" class="flex h-screen bg-slate-100 hidden">
        <aside id="sidebar" class="sidebar w-72 bg-white border-r border-slate-200 flex flex-col">
            <div class="p-6 border-b border-slate-200"><h1 class="text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-indigo-500 to-purple-600">Preventivo Pro</h1><p id="user-email" class="text-xs text-slate-500 mt-1 truncate"></p></div>
            <nav class="flex-1 px-4 py-4 space-y-4 overflow-y-auto">
                <div><h2 class="px-2 mb-2 text-xs font-semibold tracking-wider text-slate-400 uppercase">Menu</h2>
                    <a href="#" id="nav-dashboard" class="nav-link flex items-center gap-3 px-3 py-2 text-sm font-medium text-slate-700 rounded-lg hover:bg-slate-100 transition-colors"><svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M2 10a8 8 0 018-8v8h8a8 8 0 11-16 0z" /><path d="M12 2.252A8.014 8.014 0 0117.748 8H12V2.252z" /></svg>Dashboard</a>
                    <a href="#" id="nav-new-quote" class="nav-link flex items-center gap-3 px-3 py-2 text-sm font-medium text-slate-700 rounded-lg hover:bg-slate-100 transition-colors"><svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M5.433 13.917l1.262-3.155A4 4 0 017.58 9.42l6.92-6.918a2.121 2.121 0 013 3l-6.92 6.918c-.383.383-.84.685-1.343.886l-3.154 1.262a.5.5 0 01-.65-.65z" /></svg>Nuovo Preventivo</a>
                    <a href="#" id="nav-archive" class="nav-link flex items-center gap-3 px-3 py-2 text-sm font-medium text-slate-700 rounded-lg hover:bg-slate-100 transition-colors"><svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.518.759a1.12 1.12 0 00-.437 1.368l1.414 2.121a1.12 1.12 0 001.368.437l.759-1.518a1 1 0 011.06-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z" /></svg>Archivio Preventivi</a>
                </div>
                <div id="library-section"><h2 class="px-2 mb-2 text-xs font-semibold tracking-wider text-slate-400 uppercase">Librerie</h2><div id="saved-clients-list" class="space-y-1"></div><button id="add-client-btn" class="w-full mt-2 flex items-center justify-center gap-2 px-3 py-2 text-sm bg-slate-100 text-slate-600 font-semibold rounded-lg hover:bg-slate-200 transition-colors">Nuovo Cliente</button><div id="saved-products-list" class="mt-4 space-y-1"></div><button id="add-product-btn" class="w-full mt-2 flex items-center justify-center gap-2 px-3 py-2 text-sm bg-slate-100 text-slate-600 font-semibold rounded-lg hover:bg-slate-200 transition-colors">Nuovo Prodotto</button></div>
                <div class="mt-6 pt-4 border-t border-slate-200"><h2 class="px-2 mb-2 text-xs font-semibold tracking-wider text-slate-400 uppercase">Impostazioni</h2>
                    <div class="px-2 space-y-3">
                        <div><label for="next-quote-number" class="text-sm font-medium text-slate-700">Prossimo N° Preventivo</label><input type="number" id="next-quote-number" value="1" class="mt-1 w-full p-2 border border-slate-300 rounded-md"></div>
                        <div><label for="logo-upload-btn" class="text-sm font-medium text-slate-700">Logo Azienda</label><div class="flex items-center gap-4 mt-1"><img id="logo-preview" src="https://placehold.co/100x40/e2e8f0/94a3b8?text=Logo" alt="Logo preview" class="h-10 w-auto bg-slate-200 rounded"><button id="logo-upload-btn" class="text-sm font-semibold text-indigo-600 hover:text-indigo-800">Carica</button><input type="file" id="logo-upload" class="hidden" accept="image/*"></div></div>
                        <div><label for="pdf-color" class="text-sm font-medium text-slate-700">Colore PDF</label><input type="color" id="pdf-color" value="#4f46e5" class="mt-1 w-full h-8 p-0 border-none rounded cursor-pointer"></div>
                    </div>
                </div>
            </nav>
            <div class="p-4 border-t border-slate-200">
                <button id="logout-btn" class="w-full flex items-center justify-center gap-2 px-3 py-2 text-sm bg-slate-100 text-slate-600 font-semibold rounded-lg hover:bg-red-100 hover:text-red-700 transition-colors">
                    <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 3a1 1 0 00-1 1v12a1 1 0 102 0V4a1 1 0 00-1-1zm10.293 9.293a1 1 0 001.414 1.414l3-3a1 1 0 000-1.414l-3-3a1 1 0 10-1.414 1.414L14.586 9H7a1 1 0 100 2h7.586l-1.293 1.293z" clip-rule="evenodd" /></svg>
                    Logout
                </button>
            </div>
        </aside>

        <div class="flex-1 flex flex-col overflow-y-auto">
            <header class="bg-white/80 backdrop-blur-lg sticky top-0 z-20 p-4 border-b border-slate-200 flex items-center justify-between"><button id="menu-toggle" class="md:hidden p-2 rounded-md text-slate-600 hover:bg-slate-200"><svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" /></svg></button><h2 id="page-title" class="text-lg font-semibold">Dashboard</h2><div id="header-actions" class="flex items-center gap-3 hidden"><button id="reset-btn" class="px-4 py-2 bg-slate-200 text-slate-700 font-semibold rounded-lg hover:bg-slate-300 transition-colors text-sm">Svuota</button><button id="save-quote-btn" class="px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition-colors text-sm">Salva Preventivo</button><button id="generate-pdf-btn" class="gradient-button px-4 py-2 text-white font-semibold rounded-lg flex items-center justify-center gap-2 text-sm">Genera PDF</button></div></header>
            <main class="p-4 sm:p-6 lg:p-8">
                <div id="view-dashboard" class="space-y-8">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-md"><h3 class="text-lg font-semibold text-slate-700 mb-4">Fatturato Accettato (Ultimi 6 Mesi)</h3><div class="relative h-64 md:h-80"><canvas id="revenueChart"></canvas></div></div>
                        <div class="bg-white p-6 rounded-2xl shadow-md"><h3 class="text-lg font-semibold text-slate-700 mb-4">Stato Preventivi</h3><div class="relative h-64 md:h-80"><canvas id="statusChart"></canvas></div></div>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-md"><h3 class="text-lg font-semibold text-slate-700 mb-4">Top 5 Clienti per Valore Accettato</h3><div id="top-clients-list"></div></div>
                </div>
                <div id="view-new-quote" class="hidden space-y-8"><div class="bg-white p-6 rounded-2xl shadow-md"><div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6"><div class="space-y-4"><h3 class="text-lg font-semibold text-slate-700">I Tuoi Dati</h3><input type="text" id="companyName" placeholder="Nome Azienda" class="w-full p-2.5 border border-slate-300 rounded-lg"><input type="text" id="companyAddress" placeholder="Indirizzo" class="w-full p-2.5 border border-slate-300 rounded-lg"><input type="text" id="companyVat" placeholder="P.IVA / Cod. Fiscale" class="w-full p-2.5 border border-slate-300 rounded-lg"><input type="tel" id="companyPhone" placeholder="Telefono" class="w-full p-2.5 border border-slate-300 rounded-lg"><input type="email" id="companyEmail" placeholder="Email" class="w-full p-2.5 border border-slate-300 rounded-lg"></div><div class="space-y-4"><h3 class="text-lg font-semibold text-slate-700">Dati Cliente</h3><input type="text" id="clientName" placeholder="Nome Cliente" class="w-full p-2.5 border border-slate-300 rounded-lg"><input type="text" id="clientAddress" placeholder="Indirizzo Cliente" class="w-full p-2.5 border border-slate-300 rounded-lg"><input type="text" id="clientVat" placeholder="P.IVA / Cod. Fiscale Cliente" class="w-full p-2.5 border border-slate-300 rounded-lg"><input type="tel" id="clientPhone" placeholder="Telefono Cliente" class="w-full p-2.5 border border-slate-300 rounded-lg"><input type="email" id="clientEmail" placeholder="Email Cliente" class="w-full p-2.5 border border-slate-300 rounded-lg"></div></div></div><div class="bg-white p-6 rounded-2xl shadow-md"><h3 class="text-lg font-semibold text-slate-700 mb-2">Descrizione Generale Lavori</h3><textarea id="work-description" class="w-full p-2.5 border border-slate-300 rounded-lg h-24" placeholder="Descrivi qui l'oggetto del preventivo..."></textarea></div><div class="bg-white p-6 rounded-2xl shadow-md"><h3 class="text-lg font-semibold text-slate-700 mb-4">Dettaglio Lavori</h3><div class="hidden md:grid grid-cols-12 gap-x-4 mb-2 text-sm font-bold text-slate-500 uppercase tracking-wider"><div class="col-span-1 text-center">ID</div><div class="col-span-4">Descrizione</div><div class="col-span-1 text-center">UDS</div><div class="col-span-2 text-center">Qtà</div><div class="col-span-2 text-right">Prezzo</div><div class="col-span-2 text-right">Totale</div></div><div id="items-container" class="divide-y md:divide-y-0 divide-slate-200 -mx-3 md:mx-0"></div><button id="add-item-row-btn" class="mt-4 flex items-center gap-2 px-3 py-2 bg-indigo-100 text-indigo-600 font-semibold rounded-lg hover:bg-indigo-200 transition-colors text-sm">Aggiungi Riga</button></div><div class="grid grid-cols-1 lg:grid-cols-3 gap-8"><div class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-md"><h3 class="text-lg font-semibold text-slate-700 mb-2">Note, Termini e Condizioni</h3><textarea id="notes" class="w-full p-2.5 border border-slate-300 rounded-lg h-24" placeholder="Es. Pagamento a 30 giorni..."></textarea></div><div class="w-full bg-white p-6 rounded-2xl shadow-md space-y-3"><div class="flex justify-between items-center"><span class="font-medium text-slate-500">Imponibile</span><span id="subtotal" class="font-semibold text-lg text-slate-700">0.00 €</span></div><div class="flex justify-between items-center"><label for="vat" class="font-medium text-slate-500">IVA (%)</label><input type="number" id="vat" value="22" class="w-20 p-1.5 border border-slate-300 rounded-md text-right"></div><div class="flex justify-between items-center"><span class="font-medium text-slate-500">Importo IVA</span><span id="vat-amount" class="font-semibold text-lg text-slate-700">0.00 €</span></div><div class="flex justify-between items-center p-4 bg-slate-50 rounded-lg mt-4"><span class="font-bold text-xl text-slate-800">TOTALE</span><span id="total" class="font-bold text-2xl text-transparent bg-clip-text bg-gradient-to-r from-indigo-500 to-purple-600">0.00 €</span></div></div></div></div>
                <div id="view-archive" class="hidden"><div class="bg-white p-6 rounded-2xl shadow-md"><div id="archive-list" class="divide-y divide-slate-200"></div></div></div>
            </main>
        </div>
    </div>
    
    <div id="overlay" class="hidden md:hidden"></div>
    <div id="client-modal" class="modal fixed inset-0 bg-slate-900/70 items-center justify-center z-50 p-4"><div class="bg-white w-full max-w-md p-6 rounded-2xl shadow-xl"><h2 class="text-xl font-bold mb-4">Nuovo Cliente</h2><input type="text" id="modal-client-name" placeholder="Nome Cliente" class="w-full p-2.5 border border-slate-300 rounded-lg mb-3"><input type="text" id="modal-client-address" placeholder="Indirizzo" class="w-full p-2.5 border border-slate-300 rounded-lg mb-3"><input type="text" id="modal-client-vat" placeholder="P.IVA / Cod. Fiscale" class="w-full p-2.5 border border-slate-300 rounded-lg mb-3"><input type="tel" id="modal-client-phone" placeholder="Telefono" class="w-full p-2.5 border border-slate-300 rounded-lg mb-3"><input type="email" id="modal-client-email" placeholder="Email" class="w-full p-2.5 border border-slate-300 rounded-lg mb-4"><div class="flex justify-en
